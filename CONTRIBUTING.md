# Contributing Guide

Hi! We, the maintainers, are really excited that you are interested in contributing to this project. Before submitting your contribution though, please make sure to take a moment and read through the [Code of Conduct](CODE_OF_CONDUCT.md), as well as the appropriate section for the contribution you intend to make:

- [Issue Reporting Guidelines](#issue-reporting-guidelines)
- [Pull Request Guidelines](#pull-request-guidelines)
- [Development Guide](#development-guide)

## Issue Reporting Guidelines

- The issue list of this repo is **exclusively** for bug reports and feature requests of this project only. General cef issues should go to [CEF issue list](https://github.com/chromiumembedded/cef/issues).

- If you have any question, please visit [CEF Forum](https://magpcss.org/ceforum/index.php) for answers.

- Issue must follow the issue template format. If it's a bug report, reproduce steps must be provided. Otherwise, the issue will be closed.

## Pull Request Guidelines

- The title and commits should follow [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0-beta.4/).

- Add changes in CHANGELOG.md. It should be the same as the title.

- It's OK to have multiple small commits as you work on the PR - we will let GitHub automatically squash it before merging.

## Development Guide

### Quick start

#### Download CEF from [cef-builds](https://cef-builds.spotifycdn.com/index.html)

```sh
cd sys
./upgrade.rs x86_64-unknown-linux-gnu --download
```

#### Build

```sh
cargo build
```

### Architecture

Like many FFI crates, there are two crates in this repo: `cef-rs` in root and `cef-sys` in sys directory. `cef-sys` contains C APIs generated by [sys/upgrade.rs](./sys/upgrade.rs). You shouldn't edit the code directly in this crate. `cef-rs` is where type safe bindings land. Most features and implementation should go here.

### Upgrade CEF bindings

#### [Install clang](https://github.com/rust-lang/rust-bindgen/blob/main/book/src/requirements.md#clang)

#### Install bindgen

```sh
cargo install bindgen-cli
```

#### Download CEF

```sh
cd sys

./upgrade.rs x86_64-unknown-linux-gnu --download
```
This command will download and extract prebuilt CEF from [cef-builds](https://cef-builds.spotifycdn.com/index.html) into `sys/cef/archive` as specified by `[env.CEF_PATH]` in [.cargo/config.toml](./.cargo/config.toml).

#### Bindgen

```sh
cd sys
./upgrade.rs x86_64-unknown-linux-gnu --bindgen
```
This command will generate bindings into `sys/bindings/<target>` with `bindgen`.

### Debugging

#### macOS

##### lldb

1. Download CEF symbols from [cef-builds](https://cef-builds.spotifycdn.com/index.html) and extract it.

2. Launch CEF executable file

```sh
lldb -- <path-of-cef-binary>
```

3. Load symbols in lldb

```sh
(lldb) add-dsym <path-of-Chromium\ Embedded Framework.dSYM>
```

4. Source mapping

CEF is a wrapper of chromium, chromium source code is needed if you wanna step into chromium with code, get CEF code along with chromium: [BuildQuickStart](https://bitbucket.org/chromiumembedded/cef/wiki/MasterBuildQuickStart.md)

For example, download CEF version `130.1.16+g5a7e5ed+chromium-130.0.6723.117`: `python3 automate/automate-git.py --download-dir=<code-path> --no-distrib --no-build --arm64-build --checkout 5a7e5ed` the checkout commit hash is wrapped in `g<commit>`

After lldb symbols loading, execute `image lookup -vn cef_execute_process` in lldb session, it shoud print out the
compileunit of `cef_execute_process`, copy the prefix of compileunit's file `/Users/spotify-buildagent/buildAgent/work/dci-wd/desktop/cef-tools/CEF3_git/chromium/src/`(checkout [Debugging LLDB with source stepping](https://werat.dev/blog/debugging-lldb-with-source-stepping/) for another way to get the path).

```sh
(lldb) image lookup -vn cef_execute_process
1 match found in /repo/cef-rs/target/debug/examples/bundle/osx/demo.app/Contents/Frameworks/Chromium Embedded Framework.framework/Chromium Embedded Framework:
        Address: Chromium Embedded Framework[0x000000000028a0fc] (Chromium Embedded Framework.__TEXT.__text + 2646268)
        Summary: Chromium Embedded Framework`::cef_execute_process(const cef_main_args_t *, _cef_app_t *, void *) at libcef_dll.cc:66:7
         Module: file = "/repo/cef-rs/target/debug/examples/bundle/osx/demo.app/Contents/Frameworks/Chromium Embedded Framework.framework/Chromium Embedded Framework", arch = "arm64"
    CompileUnit: id = {0x00000068}, file = "/Users/spotify-buildagent/buildAgent/work/dci-wd/desktop/cef-tools/CEF3_git/chromium/src/cef/libcef_dll/libcef_dll.cc", language = "c++14"
       Function: id = {0x005e6349}, name = "::cef_execute_process(const cef_main_args_t *, _cef_app_t *, void *)", range = [0x000000010baf20fc-0x000000010baf21a4)
       FuncType: id = {0x005e6349}, byte-size = 0, decl = libcef_dll.cc:59, compiler_type = "int (const cef_main_args_t *, struct _cef_app_t *, void *)"
         Blocks: id = {0x005e6349}, range = [0x10baf20fc-0x10baf21a4)
      LineEntry: [0x000000010baf20fc-0x000000010baf2118): /Users/spotify-buildagent/buildAgent/work/dci-wd/desktop/cef-tools/CEF3_git/chromium/src/cef/libcef_dll/libcef_dll.cc:66:7
         Symbol: id = {0x001043b0}, range = [0x000000010baf20fc-0x000000010baf21a4), name="cef_execute_process"
       Variable: id = {0x005e6363}, name = "args", type = "const cef_main_args_t *", valid ranges = <block>, location = [0x000000000028a0fc, 0x000000000028a12c) -> DW_OP_reg0 W0, decl = libcef_dll.cc:59
       Variable: id = {0x005e6373}, name = "application", type = "_cef_app_t *", valid ranges = <block>, location = [0x000000000028a0fc, 0x000000000028a11c) -> DW_OP_reg1 W1, decl = libcef_dll.cc:60
       Variable: id = {0x005e6383}, name = "windows_sandbox_info", type = "void *", valid ranges = <block>, location = [0x000000000028a0fc, 0x000000000028a118) -> DW_OP_reg2 W2, decl = libcef_dll.cc:61
       Variable: id = {0x005e6393}, name = "argsVal", type = "CefMainArgs", valid ranges = <block>, location = DW_OP_breg31 WSP+0, decl = libcef_dll.cc:72
```

Finally add a sourcemap to lldb.

```
(lldb) settings append target.source-map /Users/spotify-buildagent/buildAgent/work/dci-wd/desktop/cef-tools/CEF3_git/chromium/src/ <path-of-downloaded-chromium/src/>
```


